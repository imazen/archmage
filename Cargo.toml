[workspace]
members = [".", "archmage-macros", "magetypes", "xtask"]

[package]
name = "archmage"
version = "0.8.3"
edition = "2024"
rust-version = "1.89"
license = "MIT OR Apache-2.0"
description = "Safely invoke your intrinsic power, using the tokens granted to you by the CPU. Cast primitive magics faster than any mage alive."
repository = "https://github.com/imazen/archmage"
documentation = "https://docs.rs/archmage"
keywords = ["simd", "avx", "neon", "wasm", "safe"]
categories = ["development-tools", "hardware-support", "no-std"]

[features]
default = ["std", "macros", "safe_unaligned_simd"]
std = []
macros = ["dep:archmage-macros"]
safe_unaligned_simd = ["dep:safe_unaligned_simd"]
# AVX-512 token support (Avx512Token, X64V4xToken, X64V4Token, etc.)
avx512 = []
# Make token disabling work even when compiled with -Ctarget-cpu=native.
# Without this, the compiler bakes summon() into a no-op and tokens can't be
# disabled at runtime. With this, compiled_with() returns None and summon()
# uses runtime detection + cache, so dangerously_disable_token_process_wide()
# and for_each_token_permutation() always work.
testable_dispatch = []

[dependencies]
# Proc-macro crate for #[arcane] attribute
archmage-macros = { version = "0.8.3", path = "archmage-macros", optional = true }
# Safe unaligned SIMD load/store (reference-based, no raw pointers)
safe_unaligned_simd = { version = "0.2.4", optional = true }

# Dev dependencies that don't support WASM
[target.'cfg(not(target_arch = "wasm32"))'.dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }
trybuild = "1.0"
safe_unaligned_simd = { version = "0.2.4", features = ["avx512"] }
# SIMD types for tests and examples
magetypes = { path = "magetypes", features = ["avx512"] }

[[bench]]
name = "tokens"
harness = false

[[bench]]
name = "asm_inspection"
harness = false

[[bench]]
name = "summon_overhead"
harness = false

[[bench]]
name = "safe_memory_overhead"
harness = false

[[bench]]
name = "asm_patterns"
harness = false

[package.metadata.docs.rs]
features = ["std", "macros", "safe_unaligned_simd", "avx512"]
rustdoc-args = ["--cfg", "docsrs"]
# Build docs for multiple targets to show all platform-specific tokens
targets = ["x86_64-unknown-linux-gnu", "aarch64-unknown-linux-gnu", "wasm32-unknown-unknown"]
